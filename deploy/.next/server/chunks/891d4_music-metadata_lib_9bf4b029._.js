module.exports=[285395,e=>{"use strict";var t=e.i(317890),a=e.i(348003),r=e.i(807668),i=e.i(240224),s=e.i(919685),n=e.i(180600);let d=(0,r.default)("music-metadata:id3v2:frame-parser"),o="latin1";function l(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?s.Genres[Number.parseInt(e,10)]:void 0}class c{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,r,s){let n;if(0===e.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${r}`);let{encoding:u,bom:m}=i.TextEncodingToken.get(e,0),g=e.length,p=0,f=[],y=c.getNullTerminatorLength(u);switch(d(`Parsing tag type=${r}, encoding=${u}, bom=${m}`),"TXXX"!==r&&"T"===r[0]?"T*":r){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let t;try{t=a.decodeString(e.subarray(1),u).replace(/\x00+$/,"")}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${r} header has invalid string value: ${e.message}`);break}throw e}switch(r){case"TMCL":case"TIPL":case"IPLS":f=c.functionList(this.splitValue(r,t));break;case"TRK":case"TRCK":case"TPOS":f=t;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":f=this.splitValue(r,t);break;case"TCO":case"TCON":f=this.splitValue(r,t).map(e=>(function(e){let t,a=[],r="";for(let i of e)if("string"==typeof t)if("("===i&&""===t)r+="(",t=void 0;else if(")"===i){""!==r&&(a.push(r),r="");let e=l(t);e&&a.push(e),t=void 0}else t+=i;else"("===i?t="":r+=i;return r&&(0===a.length&&r.match(/^\d*$/)&&(r=l(r)),r&&a.push(r)),a})(e)).reduce((e,t)=>e.concat(t),[]);break;case"PCS":case"PCST":f=Array.isArray(f=this.major>=4?this.splitValue(r,t):[t])&&""===f[0]?1:0;break;default:f=this.major>=4?this.splitValue(r,t):[t]}break}case"TXXX":{let t=c.readIdentifierAndData(e,p+1,g,u);f={description:t.id,text:this.splitValue(r,a.decodeString(t.data,u).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(s){let t={};switch(p+=1,this.major){case 2:t.format=a.decodeString(e.subarray(p,p+3),"latin1"),p+=3;break;case 3:case 4:n=a.findZero(e,p,g,o),t.format=a.decodeString(e.subarray(p,n),o),p=n+1;break;default:throw function(e){throw new h(`Unexpected majorVer: ${e}`)}(this.major)}t.format=c.fixPictureMimeType(t.format),t.type=i.AttachedPictureType[e[p]],p+=1,n=a.findZero(e,p,g,u),t.description=a.decodeString(e.subarray(p,n),u),p=n+y,t.data=e.subarray(p,g),f=t}break;case"CNT":case"PCNT":f=(0,a.decodeUintBE)(e);break;case"SYLT":{let a=i.SyncTextHeader.get(e,0);p+=i.SyncTextHeader.len;let r={descriptor:"",language:a.language,contentType:a.contentType,timeStampFormat:a.timeStampFormat,syncText:[]},s=!1;for(;p<g;){let i=c.readNullTerminatedString(e.subarray(p),a.encoding);if(p+=i.len,s){let a=t.UINT32_BE.get(e,p);p+=t.UINT32_BE.len,r.syncText.push({text:i.text,timestamp:a})}else r.descriptor=i.text,s=!0}f=r;break}case"ULT":case"USLT":case"COM":case"COMM":{let t=i.TextHeader.get(e,p);p+=i.TextHeader.len;let a=c.readNullTerminatedString(e.subarray(p),t.encoding);p+=a.len;let r=c.readNullTerminatedString(e.subarray(p),t.encoding);f={language:t.language,descriptor:a.text,text:r.text};break}case"UFID":{let t=c.readIdentifierAndData(e,p,g,o);f={owner_identifier:t.id,identifier:t.data};break}case"PRIV":{let t=c.readIdentifierAndData(e,p,g,o);f={owner_identifier:t.id,data:t.data};break}case"POPM":{n=a.findZero(e,p,g,o);let r=a.decodeString(e.subarray(p,n),o),i=g-(p=n+1)-1;f={email:r,rating:t.UINT8.get(e,p),counter:i>0?a.decodeUintBE(e.subarray(p+1)):void 0};break}case"GEOB":{n=a.findZero(e,p+1,g,u);let t=a.decodeString(e.subarray(p+1,n),o);p=n+1,n=a.findZero(e,p,g,u);let r=a.decodeString(e.subarray(p,n),o);p=n+1,n=a.findZero(e,p,g,u);let i=a.decodeString(e.subarray(p,n),o);p=n+1,f={type:t,filename:r,description:i,data:e.subarray(p,g)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":n=a.findZero(e,p+1,g,u),f=a.decodeString(e.subarray(p,n),o);break;case"WXXX":{n=a.findZero(e,p+1,g,u);let t=a.decodeString(e.subarray(p+1,n),u);p=n+("utf-16le"===u?2:1),f={description:t,url:a.decodeString(e.subarray(p,g),o)};break}case"WFD":case"WFED":f=a.decodeString(e.subarray(p+1,a.findZero(e,p+1,g,u)),u);break;case"MCDI":f=e.subarray(0,g);break;default:d(`Warning: unsupported id3v2-tag-type: ${r}`)}return f}static readNullTerminatedString(e,t){let r=2*!!t.bom,i=a.findZero(e,r,e.length,t.encoding),s=e.subarray(r,i);return r="utf-16le"===t.encoding?i+2:i+1,{text:a.decodeString(s,t.encoding),len:r}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){let t={};for(let a=0;a+1<e.length;a+=2){let r=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(r):r}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g)).length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g):a=t.split(/\x00/g),c.trimArray(a)}static trimArray(e){return e.map(e=>e.replace(/\x00+$/,"").trim())}static readIdentifierAndData(e,t,r,i){let s=a.findZero(e,t,r,i),n=a.decodeString(e.subarray(t,s),i);return t=s+c.getNullTerminatorLength(i),{id:n,data:e.subarray(t,r)}}static getNullTerminatorLength(e){return"utf-16le"===e?2:1}}class h extends(0,n.makeUnexpectedFileContentError)("id3v2"){}var u=e.i(245387);class m{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.subarray(0,a)}static getFrameHeaderLength(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw g(e)}}static readFrameFlags(e){return{status:{tag_alter_preservation:a.getBit(e,0,6),file_alter_preservation:a.getBit(e,0,5),read_only:a.getBit(e,0,4)},format:{grouping_identity:a.getBit(e,1,7),compression:a.getBit(e,1,3),encryption:a.getBit(e,1,2),unsynchronisation:a.getBit(e,1,1),data_length_indicator:a.getBit(e,1,0)}}}static readFrameData(e,t,a,r,i){let s=new c(a,i);switch(a){case 2:return s.readData(e,t.id,r);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=m.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.subarray(4,e.length)),s.readData(e,t.id,r);default:throw g(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;let r=await this.tokenizer.readToken(i.ID3v2Header);if("ID3"!==r.fileIdentifier)throw new h("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=r,this.headerType=`ID3v2.${r.version.major}`,r.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(r.size)}async parseExtendedHeader(){let e=await this.tokenizer.readToken(i.ExtendedHeader),t=e.size-i.ExtendedHeader.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){let a=await this.tokenizer.readToken(new t.Uint8ArrayType(e));for(let e of this.parseMetadata(a))"TXXX"===e.id?e.value&&await this.handleTag(e,e.value.text,()=>e.value.description):await (Array.isArray(e.value)?Promise.all(e.value.map(t=>this.addTag(e.id,t))):this.addTag(e.id,e.value))}async handleTag(e,t,a,r=e=>e){await Promise.all(t.map(t=>this.addTag(m.makeDescriptionTagName(e.id,a(t)),r(t))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let t=0,a=[];for(;t!==e.length;){let r=m.getFrameHeaderLength(this.id3Header.version.major);if(t+r>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}let i=e.subarray(t,t+r);t+=r;let s=this.readFrameHeader(i,this.id3Header.version.major),n=e.subarray(t,t+s.length);t+=s.length;let d=m.readFrameData(n,s,this.id3Header.version.major,!this.options.skipCovers,this.metadata);d&&a.push({id:s.id,value:d})}return a}readFrameHeader(e,a){let r;switch(a){case 2:(r={id:(0,u.textDecode)(e.subarray(0,3),"ascii"),length:t.UINT24_BE.get(e,3)}).id.match(/[A-Z0-9]{3}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;case 3:case 4:(r={id:(0,u.textDecode)(e.subarray(0,4),"ascii"),length:(4===a?i.UINT32SYNCSAFE:t.UINT32_BE).get(e,4),flags:m.readFrameFlags(e.subarray(8,10))}).id.match(/[A-Z0-9]{4}/g)||this.metadata.addWarning(`Invalid ID3v2.${this.id3Header.version.major} frame-header-ID: ${r.id}`);break;default:throw g(a)}return r}}function g(e){throw new h(`Unexpected majorVer: ${e}`)}e.s(["ID3v2Parser",()=>m],285395)},936774,e=>{"use strict";e.i(635777);var t=e.i(274749),a=e.i(807668),r=e.i(240224),i=e.i(285395),s=e.i(919685),n=e.i(563943);let d=(0,a.default)("music-metadata:parser:ID3");class o extends n.BasicParser{constructor(){super(...arguments),this.id3parser=new i.ID3v2Parser}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(r.ID3v2Header)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(e instanceof t.EndOfStreamError)d("End-of-stream");else throw e}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),d("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{let e=new s.ID3v1Parser(this.metadata,this.tokenizer,this.options);await e.parse(),this.finalize()}}async tryReadId3v2Headers(){if("ID3"===(await this.tokenizer.peekToken(r.ID3v2Header)).fileIdentifier)return d("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}e.s(["AbstractID3Parser",()=>o])},670101,e=>{"use strict";var t=e.i(807668),a=e.i(317890),r=e.i(936774),i=e.i(563943),s=e.i(248790),n=e.i(830651),d=e.i(348003);let o=(0,t.default)("music-metadata:parser:musepack:sv8"),l=new a.StringType(2,"latin1"),c={len:5,get:(e,t)=>({crc:a.UINT32_LE.get(e,t),streamVersion:a.UINT8.get(e,t+4)})},h={len:2,get:(e,t)=>({sampleFrequency:[44100,48e3,37800,32e3][d.getBitAllignedNumber(e,t,0,3)],maxUsedBands:d.getBitAllignedNumber(e,t,3,5),channelCount:d.getBitAllignedNumber(e,t+1,0,4)+1,msUsed:d.isBitSet(e,t+1,4),audioBlockFrames:d.getBitAllignedNumber(e,t+1,5,3)})};class u{get tokenizer(){return this._tokenizer}set tokenizer(e){this._tokenizer=e}constructor(e){this._tokenizer=e}async readPacketHeader(){let e=await this.tokenizer.readToken(l),t=await this.readVariableSizeField();return{key:e,payloadLength:t.value-2-t.len}}async readStreamHeader(e){let t={};o(`Reading SH at offset=${this.tokenizer.position}`);let a=await this.tokenizer.readToken(c);e-=c.len,Object.assign(t,a),o(`SH.streamVersion = ${a.streamVersion}`);let r=await this.readVariableSizeField();e-=r.len,t.sampleCount=r.value;let i=await this.readVariableSizeField();e-=i.len,t.beginningOfSilence=i.value;let s=await this.tokenizer.readToken(h);return e-=h.len,Object.assign(t,s),await this.tokenizer.ignore(e),t}async readVariableSizeField(e=1,t=0){let r=await this.tokenizer.readNumber(a.UINT8);return(128&r)==0?{len:e,value:t+r}:(r&=127,r+=t,this.readVariableSizeField(e+1,r<<7))}}var m=e.i(180600);class g extends(0,m.makeUnexpectedFileContentError)("Musepack"){}let p=(0,t.default)("music-metadata:parser:musepack");class f extends i.BasicParser{constructor(){super(...arguments),this.audioLength=0}async parse(){if("MPCK"!==await this.tokenizer.readToken(n.FourCcToken))throw new g("Invalid Magic number");return this.metadata.setFormat("container","Musepack, SV8"),this.parsePacket()}async parsePacket(){let e=new u(this.tokenizer);for(;;){let t=await e.readPacketHeader();switch(p(`packet-header key=${t.key}, payloadLength=${t.payloadLength}`),t.key){case"SH":{let a=await e.readStreamHeader(t.payloadLength);this.metadata.setFormat("numberOfSamples",a.sampleCount),this.metadata.setFormat("sampleRate",a.sampleFrequency),this.metadata.setFormat("duration",a.sampleCount/a.sampleFrequency),this.metadata.setFormat("numberOfChannels",a.channelCount);break}case"AP":this.audioLength+=t.payloadLength,await this.tokenizer.ignore(t.payloadLength);break;case"RG":case"EI":case"SO":case"ST":case"CT":await this.tokenizer.ignore(t.payloadLength);break;case"SE":return this.metadata.format.duration&&this.metadata.setFormat("bitrate",8*this.audioLength/this.metadata.format.duration),(0,s.tryParseApeHeader)(this.metadata,this.tokenizer,this.options);default:throw new g(`Unexpected header: ${t.key}`)}}}}var y=i;class k{constructor(e){this.pos=0,this.dword=null,this.tokenizer=e}async read(e){for(;null===this.dword;)this.dword=await this.tokenizer.readToken(a.UINT32_LE);let t=this.dword;return(this.pos+=e,this.pos<32)?(t>>>=32-this.pos)&(1<<e)-1:((this.pos-=32,0===this.pos)?this.dword=null:(this.dword=await this.tokenizer.readToken(a.UINT32_LE),this.pos&&(t<<=this.pos,t|=this.dword>>>32-this.pos)),t&(1<<e)-1)}async ignore(e){if(this.pos>0){let t=32-this.pos;this.dword=null,e-=t,this.pos=0}let t=e%32,a=(e-t)/32;return await this.tokenizer.ignore(4*a),this.read(t)}}var b=e.i(245387);let T={len:24,get:(e,t)=>{let r={signature:(0,b.textDecode)(e.subarray(t,t+3),"latin1"),streamMinorVersion:d.getBitAllignedNumber(e,t+3,0,4),streamMajorVersion:d.getBitAllignedNumber(e,t+3,4,4),frameCount:a.UINT32_LE.get(e,t+4),maxLevel:a.UINT16_LE.get(e,t+8),sampleFrequency:[44100,48e3,37800,32e3][d.getBitAllignedNumber(e,t+10,0,2)],link:d.getBitAllignedNumber(e,t+10,2,2),profile:d.getBitAllignedNumber(e,t+10,4,4),maxBand:d.getBitAllignedNumber(e,t+11,0,6),intensityStereo:d.isBitSet(e,t+11,6),midSideStereo:d.isBitSet(e,t+11,7),titlePeak:a.UINT16_LE.get(e,t+12),titleGain:a.UINT16_LE.get(e,t+14),albumPeak:a.UINT16_LE.get(e,t+16),albumGain:a.UINT16_LE.get(e,t+18),lastFrameLength:a.UINT32_LE.get(e,t+20)>>>20&2047,trueGapless:d.isBitSet(e,t+23,0)};return r.lastFrameLength=r.trueGapless?a.UINT32_LE.get(e,20)>>>20&2047:0,r}},w=(0,t.default)("music-metadata:parser:musepack");class v extends y.BasicParser{constructor(){super(...arguments),this.bitreader=null,this.audioLength=0,this.duration=null}async parse(){let e=await this.tokenizer.readToken(T);if("MP+"!==e.signature)throw new g("Unexpected magic number");w(`stream-version=${e.streamMajorVersion}.${e.streamMinorVersion}`),this.metadata.setFormat("container","Musepack, SV7"),this.metadata.setFormat("sampleRate",e.sampleFrequency);let t=1152*(e.frameCount-1)+e.lastFrameLength;this.metadata.setFormat("numberOfSamples",t),this.duration=t/e.sampleFrequency,this.metadata.setFormat("duration",this.duration),this.bitreader=new k(this.tokenizer),this.metadata.setFormat("numberOfChannels",e.midSideStereo||e.intensityStereo?2:1);let a=await this.bitreader.read(8);return this.metadata.setFormat("codec",(a/100).toFixed(2)),await this.skipAudioData(e.frameCount),w(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`),(0,s.tryParseApeHeader)(this.metadata,this.tokenizer,this.options)}async skipAudioData(e){for(;e-- >0;){let e=await this.bitreader.read(20);this.audioLength+=20+e,await this.bitreader.ignore(e)}let t=await this.bitreader.read(11);this.audioLength+=t,null!==this.duration&&this.metadata.setFormat("bitrate",this.audioLength/this.duration)}}let I=(0,t.default)("music-metadata:parser:musepack");class S extends r.AbstractID3Parser{async postId3v2Parse(){let e;switch(await this.tokenizer.peekToken(new a.StringType(3,"latin1"))){case"MP+":I("Stream-version 7"),e=new v(this.metadata,this.tokenizer,this.options);break;case"MPC":I("Stream-version 8"),e=new f(this.metadata,this.tokenizer,this.options);break;default:throw new g("Invalid signature prefix")}return this.metadata.setAudioOnly(),e.parse()}}e.s(["MusepackParser",()=>S],670101)}];

//# sourceMappingURL=891d4_music-metadata_lib_9bf4b029._.js.map